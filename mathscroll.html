<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MathScroll · Neo & Classic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React / Babel UMD -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7.22.10/babel.min.js"></script>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>

  <!-- i18n -->
  <script src="https://cdn.jsdelivr.net/npm/i18next@23.11.5/dist/umd/i18next.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-i18next@14.1.2/dist/umd/react-i18next.min.js"></script>

  <!-- MathJax -->
  <script>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},svg:{fontCache:'global'}};</script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <style>
    :root{ --nav-h:60px; --c-bg:#F9FAFB; --c-border:#D1D5DB; --c-gray:#6B7280; --c-blue:#3B82F6; --c-green:#10B981; --c-red:#EF4444; --radius:8px; --shadow:0 8px 24px rgba(15,23,42,.08);}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI','Noto Serif SC',serif;background:#fff;}
    .topnav{position:fixed;top:0;left:0;right:0;height:var(--nav-h);background:#111827;color:#fff;display:flex;align-items:center;z-index:20;}
    .nav-inner{width:100%;max-width:1200px;margin:auto;display:flex;justify-content:space-between;align-items:center;padding:0 16px;}
    .nav-links a{color:#fff;text-decoration:none;margin:0 10px;font-weight:600;padding:8px 10px;border-radius:6px}
    .nav-links a:hover{background:#3B82F6;}
    .page{padding-top:var(--nav-h);min-height:100vh;background:var(--c-bg);}
    .hero-gap{height:20vh;pointer-events:none;}
    .mode-buttons{display:flex;gap:40px;justify-content:center;position:relative;z-index:5;margin-bottom:12px}
    .mode-btn{width:200px;height:80px;border:none;border-radius:var(--radius);font-size:20px;font-weight:700;color:#fff;cursor:pointer;box-shadow:var(--shadow)}
    .mode-btn.neo{background:#3B82F6;}
    .mode-btn.classic{background:#6B7280;}
    .text-input{width:min(600px,90%);height:50px;border:1px solid var(--c-border);border-radius:6px;padding:0 12px;font-size:16px;}
    .btn{border:none;border-radius:6px;height:40px;padding:0 14px;color:#fff;cursor:pointer;font-weight:600;}
    .btn.blue{background:#3B82F6;}
    .btn.green{background:#10B981;}
    .btn.red{background:#EF4444;}
    .hint{color:var(--c-gray);font-size:14px;margin-top:6px}
    .result-card{width:min(800px,90%);margin:20px auto;background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;}
    .answer{font-size:22px;font-weight:700;color:#3B82F6;text-align:center;margin-bottom:10px}
    .tabs{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:8px;margin-bottom:8px}
    .tab-btn{width:110px;height:40px;border-radius:6px;border:1px solid var(--c-border);background:#E5E7EB;cursor:pointer;font-weight:600}
    .tab-btn.active{background:#3B82F6;color:#fff;border-color:transparent}
    .tab-panels{border:1px solid var(--c-border);border-radius:8px;padding:16px;background:#fff;min-height:320px}
    .panel{display:none}
    .panel.active{display:block}
    .canvas-2d,.canvas-3d{width:400px;height:300px;max-width:100%;margin:0 auto}
    .suggest{max-height:200px;overflow:auto;color:#374151;line-height:1.7}
    .classic-wrap{width:100%;padding:16px;display:block}
    .classic-container{display:flex;gap:16px;align-items:flex-start}
    .classic-sidebar{flex:0 0 260px;background:#F3F4F6;border:1px solid var(--c-border);border-radius:8px;padding:12px;position:sticky;top:calc(var(--nav-h) + 8px);max-height:calc(100vh - var(--nav-h) - 16px);overflow:auto}
    .classic-main{flex:1;background:#fff;border:1px solid var(--c-border);border-radius:8px;box-shadow:var(--shadow);padding:16px}
    .block{background:#fff;border:1px solid var(--c-border);border-radius:8px;padding:16px;margin:14px 0}
    .diff-col{display:flex;flex-direction:column;gap:10px}
    .diff-btn{height:42px;border:none;border-radius:6px;background:#9CA3AF;color:#fff;font-weight:700;cursor:pointer}
    .diff-btn.active{background:#3B82F6}
    .ans-input{width:min(600px,90%);height:50px;border:1px solid var(--c-border);border-radius:6px;padding:0 12px}
    .spinner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.6);color:#fff;padding:8px 12px;border-radius:6px}
    @media (max-width: 900px){ .classic-container{flex-direction:column} .classic-sidebar{position:relative;top:auto;max-height:none}}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { useTranslation, I18nextProvider } = ReactI18next;

    /* ---------- i18n ---------- */
    const i18n = window.i18next;
    i18n.use(ReactI18next.initReactI18next).init({
      resources: {
        en: { translation: {
          mathScroll:"MathScroll", classicsStudio:"Classics Studio", scholarsCache:"Scholar’s Cache", aboutWeaver:"About the Weaver",
          neoMode:"Neo Mode", classicMode:"Classic Mode", submit:"Submit", handwrite:"Handwrite Input",
          addToWrongbook:"Add to Wrongbook", neoPlaceholder:"Try: Solve 2x²+3x+1=0",
          showAncient:"Show Ancient Text", hideAncient:"Hide Ancient Text",
          nextQuestion:"Next Question", step:"Step", suggestion:"Suggestion",
          '2d':"2D", '3d':"3D", formula:"Formula",
          loading:"Loading...", clear:"Clear", confirm:"Confirm", close:"Close",
          errorSubmit:"Please enter a question",
          learnAlgorithms:"Learn Algorithms", challengeMode:"Challenge Mode", menu:"Menu", answerPlaceholder:"Your answer...",
          correct:"Correct!", incorrect:"Incorrect, try again.",
          favorites:"Favorites", wrongbook:"Wrongbook",
          Basic:"Basic", Medium:"Medium", Advanced:"Advanced",
          easy:"Basic", mid:"Medium", hard:"Advanced",
          noQuestions:"No questions available"
        }},
        zh: { translation: {
          mathScroll:"算卷", classicsStudio:"经典坊", scholarsCache:"学藏", aboutWeaver:"织者志",
          neoMode:"Neo 模式", classicMode:"经典模式", submit:"提交", handwrite:"手写输入",
          addToWrongbook:"加入错题本", neoPlaceholder:"试试：求解 2x²+3x+1=0",
          showAncient:"显示原文", hideAncient:"收起原文",
          nextQuestion:"下一题", step:"步骤", suggestion:"建议",
          '2d':"二维", '3d':"三维", formula:"公式",
          loading:"加载中...", clear:"清除", confirm:"确认", close:"关闭",
          errorSubmit:"请输入题目",
          learnAlgorithms:"学习目录", challengeMode:"挑战模式", menu:"目录", answerPlaceholder:"你的答案...",
          correct:"正确！", incorrect:"不对，再试试。",
          favorites:"收藏夹", wrongbook:"错题本",
          Basic:"基础", Medium:"中等", Advanced:"困难",
          easy:"基础", mid:"中等", hard:"困难",
          noQuestions:"暂无题目"
        }}
      },
      lng: localStorage.getItem('language') || 'en',
      fallbackLng: 'en',
      interpolation: { escapeValue: false }
    });

    /* ---------- 小工具 ---------- */
    function pickLang(i18n, en, zh){ return i18n.language==='zh' ? (zh ?? en) : en; }

    // 简单启发式 Suggestion
    function suggestByHeuristics(input){
      const s = (input||'').toLowerCase();
      if(/x\^?2|x\*\*2|quadratic|ax\^2|=0/.test(s)){
        return 'Quadratic: try factoring, completing the square, or the quadratic formula; check the discriminant b^2-4ac.';
      }
      if(/integral|∫|\\int/.test(s)){
        return 'Integration: consider substitution, integration by parts, or standard antiderivatives; set limits carefully.';
      }
      if(/derivative|d\/dx|\\frac{d}/.test(s)){
        return 'Differentiation: use power/product/quotient/chain rules; simplify before and after; watch domains.';
      }
      if(/system|solve for .* and .*|,/.test(s)){
        return 'Systems: try substitution or elimination; for 3 variables consider row-reduction / matrix methods.';
      }
      return 'Rewrite into a standard form; check domain and units; try simpler equivalent formulations.';
    }

    /* ---------- 题库 ---------- */
    const questionBank = {
      easy: [
        { question:"Area of a field 20 by 15?", ancientText:"今有田廣二十步，從十五步。問爲田幾何。", answer:"300",
          explanation:["Step 1: Area = length × width.","Step 2: 20 × 15 = 300."] },
        { question:"If 3x = 12, find x.", ancientText:"今有三倍某數等於十二。問數幾何。", answer:"4",
          explanation:["Divide both sides by 3 → x=4."] },
        { question:"7 + 5 = ?", ancientText:"今有加法。", answer:"12",
          explanation:["7+5=12."] }
      ],
      mid: [
        { question:"Solve: 2x + 3y = 12, x - y = 1.", ancientText:"二式聯立。", answer:"(x=3, y=2)",
          explanation:["From x-y=1 ⇒ x=y+1.","Substitute to get y=2, x=3."] },
        { question:"Simplify: (x^2 - 9)/(x - 3)", ancientText:"代數化簡。", answer:"x+0+3? No → x+3",
          explanation:["Factor numerator: (x-3)(x+3)/(x-3)=x+3 (x≠3)."] }
      ],
      hard: [
        { question:"Solve: x² - 5x + 6 = 0.", ancientText:"因式分解。", answer:"(x=2, x=3)",
          explanation:["(x-2)(x-3)=0 ⇒ x=2,3."] },
        { question:"CRT: n≡2 (mod 3), n≡3 (mod 5), n≡2 (mod 7).", ancientText:"餘數定理。", answer:"23",
          explanation:["One minimal solution is 23; add lcm(3,5,7)=105 for general solutions."] }
      ]
    };

    /* ---------- 算法数据（示例） ---------- */
    const algorithmData = {
      "square-field": {
        title:"Field Area Conversion", titleZh:"田亩面积折算",
        intro:"Convert and compute farmland area using ancient rules.",
        introZh:"结合古制单位与现代单位进行田地面积换算。",
        ancientText:"今有田亩……",
        enText:"Given a field with dimensions..., compute its area.",
        easyText:"Translate old units into metric and compute areas.",
        example:{ steps:["Step 1: Area = length × width.","Step 2: 20 × 15 = 300."] }
      },
      "excess-deficiency": {
        title:"Excess & Deficiency", titleZh:"盈不足法",
        intro:"Solve problems using excess and deficiency.",
        introZh:"通过“盈不足”思想建立平衡方程并求解未知量。",
        ancientText:"今有盈不足……",
        enText:"Use excess and deficiency to find unknowns.",
        easyText:"Balance excess and deficit to solve.",
        example:{ steps:["Step 1: Model.","Step 2: Solve."] }
      }
    };

    /* ---------- 顶部导航 ---------- */
    function Navbar({ setPage }){
      const { t, i18n } = useTranslation();
      const changeLanguage=()=>{ const next=i18n.language==='en'?'zh':'en'; i18n.changeLanguage(next); localStorage.setItem('language',next); };
      return (
        <nav className="topnav">
          <div className="nav-inner">
            <div className="font-bold">NeoShuyuan</div>
            <div className="nav-links">
              <a href="#" onClick={()=>setPage('mathScroll')}>{t('mathScroll')}</a>
              <a href="#" onClick={()=>setPage('classicsStudio')}>{t('classicsStudio')}</a>
              <a href="#" onClick={()=>setPage('scholarsCache')}>{t('scholarsCache')}</a>
              <a href="#" onClick={()=>setPage('aboutWeaver')}>{t('aboutWeaver')}</a>
              <a href="#" onClick={changeLanguage}>{i18n.language==='en'?'中文':'English'}</a>
            </div>
          </div>
        </nav>
      );
    }

    /* ---------- Neo Mode ---------- */
    function NeoMode({ setWrongBook, HANDWRITE_API }){
      const { t } = useTranslation();
      const [input,setInput]=useState('');
      const [result,setResult]=useState(null);
      const [activeTab,setActiveTab]=useState('2D');
      const [loading,setLoading]=useState(false);
      const [showHandwrite,setShowHandwrite]=useState(false);
      const canvasRef=useRef(null);
      const chartRef=useRef(null);
      const threeRef=useRef(null);

      useEffect(()=>{
        if(!showHandwrite) return;
        const cvs=canvasRef.current; if(!cvs) return;
        const ctx=cvs.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,cvs.width,cvs.height);
        let drawing=false;
        const md=e=>{drawing=true; ctx.beginPath(); ctx.moveTo(e.offsetX,e.offsetY);};
        const mm=e=>{ if(!drawing) return; ctx.lineTo(e.offsetX,e.offsetY); ctx.strokeStyle='#111'; ctx.lineWidth=3; ctx.lineCap='round'; ctx.stroke();};
        const mu=()=>{drawing=false;};
        cvs.addEventListener('mousedown',md); cvs.addEventListener('mousemove',mm); cvs.addEventListener('mouseup',mu); cvs.addEventListener('mouseleave',mu);
        return ()=>{ cvs.removeEventListener('mousedown',md); cvs.removeEventListener('mousemove',mm); cvs.removeEventListener('mouseup',mu); cvs.removeEventListener('mouseleave',mu); };
      },[showHandwrite]);

      const handleHandwrite=async()=>{
        if(!HANDWRITE_API){ alert('Set HANDWRITE_API first'); return; }
        setLoading(true);
        try{
          const base64=canvasRef.current.toDataURL('image/png');
          const {data}=await axios.post(HANDWRITE_API,{ imageDataURL: base64 });
          setInput(data.latex || data.text || '');
          setShowHandwrite(false);
          if(window.MathJax) MathJax.typeset();
        }catch(e){ alert(t('errorSubmit')); }
        setLoading(false);
      };

      const handleSubmit=async()=>{
        if(!input.trim()) return alert(t('errorSubmit'));
        setLoading(true);
        try{
          const demo={
            answer: input.includes('x^2+3x+2') ? 'x = -1, -2' : 'Sample solution',
            formulaSteps:[
              'Step 1: Convert to standard form.',
              'Step 2: Factorize or use quadratic formula.',
              'Step 3: Solve: $x^2+3x+2=0 \\Rightarrow x=-1,-2$'
            ],
            suggestion: suggestByHeuristics(input),
            graphData:{
              '2d':{
                labels: Array.from({length:21},(_,i)=>i-10),
                datasets: [{ label:'y=x^2', data: Array.from({length:21},(_,i)=>(i-10)**2), fill:false }]
              }
            }
          };
          setResult(demo); setActiveTab('2D');
          if(window.MathJax) MathJax.typeset();
        }catch(e){ alert(t('errorSubmit')); }
        setLoading(false);
      };

      useEffect(()=>{
        if(activeTab!=='2D' || !result?.graphData?.['2d'] || !chartRef.current) return;
        const chart=new Chart(chartRef.current.getContext('2d'),{
          type:'line', data: result.graphData['2d'],
          options:{responsive:true,maintainAspectRatio:false,scales:{x:{title:{display:true,text:'x'}},y:{title:{display:true,text:'y'}}}}
        });
        return ()=>chart.destroy();
      },[activeTab,result]);

      useEffect(()=>{
        if(activeTab!=='3D' || !threeRef.current) return;
        const w=threeRef.current.clientWidth||400,h=threeRef.current.clientHeight||300;
        const scene=new THREE.Scene();
        const camera=new THREE.PerspectiveCamera(60,w/h,0.1,1000); camera.position.set(2,2,3);
        const renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(w,h);
        threeRef.current.innerHTML=''; threeRef.current.appendChild(renderer.domElement);
        const controls=new THREE.OrbitControls(camera,renderer.domElement);
        const light=new THREE.DirectionalLight(0xffffff,1); light.position.set(3,3,3); scene.add(light);
        const geo=new THREE.PlaneGeometry(3,3,60,60);
        const pos=geo.attributes.position;
        for(let i=0;i<pos.count;i++){ const x=pos.getX(i), y=pos.getY(i); pos.setZ(i, Math.sin(2*x)*Math.cos(2*y)/3); }
        geo.computeVertexNormals();
        const mesh=new THREE.Mesh(geo,new THREE.MeshStandardMaterial({color:0x3B82F6,side:THREE.DoubleSide}));
        mesh.rotation.x=-Math.PI/2; scene.add(mesh);
        (function anim(){ requestAnimationFrame(anim); mesh.rotation.z+=0.002; renderer.render(scene,camera); })();
        const onResize=()=>{ const w2=threeRef.current.clientWidth||400,h2=threeRef.current.clientHeight||300; camera.aspect=w2/h2; camera.updateProjectionMatrix(); renderer.setSize(w2,h2); };
        window.addEventListener('resize',onResize);
        return ()=>window.removeEventListener('resize',onResize);
      },[activeTab]);

      return (
        <div className="w-full text-center">
          <div className="flex gap-2 justify-center flex-wrap">
            <input className="text-input" value={input} onChange={e=>setInput(e.target.value)} placeholder={t('neoPlaceholder')} />
            <button className="btn blue" onClick={()=>setShowHandwrite(true)}>{t('handwrite')}</button>
            <button className="btn green" onClick={handleSubmit}>{t('submit')}</button>
          </div>
          <div className="hint">{t('neoPlaceholder')}</div>

          {showHandwrite && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
              <div className="bg-white border border-gray-300 rounded-xl p-3 w-[400px] max-w-[92vw]">
                <div className="font-bold mb-1">{t('handwrite')}</div>
                <div className="border rounded-lg overflow-hidden bg-white w-full h-[300px]">
                  <canvas ref={canvasRef} width="400" height="300"></canvas>
                </div>
                <div className="flex justify-end gap-2 mt-2">
                  <button className="btn red" onClick={()=>{const c=canvasRef.current;const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);ctx.fillStyle='#fff';ctx.fillRect(0,0,c.width,c.height);}}>{t('clear')}</button>
                  <button className="btn green" onClick={handleHandwrite}>{t('confirm')}</button>
                  <button className="btn" style={{background:'#9CA3AF',color:'#fff'}} onClick={()=>setShowHandwrite(false)}>{t('close')}</button>
                </div>
              </div>
            </div>
          )}

          {result && (
            <div className="result-card">
              <div className="answer">{result.answer}</div>
              <div className="tabs">
                {['2D','3D','Formula','Suggestion'].map(tab=>(
                  <button key={tab} className={`tab-btn ${activeTab===tab?'active':''}`} onClick={()=>{setActiveTab(tab); if(tab==='Formula' && window.MathJax) MathJax.typeset();}}>
                    {tab==='2D'?t('2d'):tab==='3D'?t('3d'):tab==='Formula'?t('formula'):t('suggestion')}
                  </button>
                ))}
              </div>
              <div className="tab-panels">
                <div className={`panel ${activeTab==='2D'?'active':''}`}><canvas ref={chartRef} className="canvas-2d"></canvas></div>
                <div className={`panel ${activeTab==='3D'?'active':''}`}><div ref={threeRef} className="canvas-3d"></div></div>
                <div className={`panel ${activeTab==='Formula'?'active':''}`}>
                  {result.formulaSteps.map((s,i)=>(
                    <details key={i} open={i===0}>
                      <summary>{t('step')} {i+1}</summary>
                      <div dangerouslySetInnerHTML={{__html:s}}></div>
                    </details>
                  ))}
                </div>
                <div className={`panel ${activeTab==='Suggestion'?'active':''}`}><div className="suggest">{result.suggestion}</div></div>
              </div>
              <button className="btn red mt-3" onClick={()=>setWrongBook(prev=>[...prev,{question:input,answer:result.answer}])}>{t('addToWrongbook')}</button>
            </div>
          )}

          {loading && <div className="spinner">{t('loading')}</div>}
        </div>
      );
    }

    /* ---------- Classic Mode ---------- */
    function ClassicMode({ setWrongBook, setFavorites }){
      const { t, i18n } = useTranslation();
      const [difficulty,setDifficulty]=useState('easy');
      const [currentQuestion,setCurrentQuestion]=useState(null);
      const [userAnswer,setUserAnswer]=useState('');
      const [showParse,setShowParse]=useState(false);
      const [isCorrect,setIsCorrect]=useState(null);
      const [selectedAlg,setSelectedAlg]=useState('square-field');
      const [activeTab,setActiveTab]=useState('
